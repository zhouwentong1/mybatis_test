<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.puhui.mapper.UserMapper">
    <!--定义 resultMap 返回类型，其中比较重要的就是 association 属性，通过这个属性进行两个表的关联-->
    <resultMap id="userOrderMap" type="com.puhui.vo.Orders">
        <id property="id" column="id"/>
        <result property="number" column="number"/>
        <result property="createtime" column="createtime"/>
        <result property="note" column="note"/>
        <result property="userId" column="user_id"/>
        <association property="user" javaType="com.puhui.vo.User">
            <id property="id" column="user_id"/>
            <result property="username" column="username"/>
            <!--<result property="birthday" column="birthday"/>-->
            <!--<result property="sex" column="sex"/>-->
            <result property="address" column="address"/>
        </association>
    </resultMap>

    <resultMap id="userOrderMap2" type="com.puhui.vo.Orders">
        <id property="id" column="id"/>
        <result property="number" column="number"/>
        <result property="createtime" column="createtime"/>
        <result property="note" column="note"/>
        <result property="userId" column="user_id"/>
        <association property="user" javaType="com.puhui.vo.User">
            <id property="id" column="user_id"/>
            <result property="username" column="username"/>
            <!--<result property="birthday" column="birthday"/>-->
            <!--<result property="sex" column="sex"/>-->
            <result property="address" column="address"/>
        </association>
        <collection property="orderdetails" ofType="orderdetail">
            <id property="id" column="orderdetail_id"/>
            <result property="itemsId" column="items_id"/>
            <result property="itemsNum" column="items_num"/>
        </collection>
    </resultMap>
    <!--resultMap 是可以继承的，其中的属性不变-->
    <resultMap id="userOrderMap3" type="orders" extends="userOrderMap">
        <collection property="orderdetails" ofType="orderdetail">
            <id property="id" column="orderdetail_id"/>
            <result property="itemsId" column="items_id"/>
            <result property="itemsNum" column="items_num"/>
        </collection>
    </resultMap>

    <resultMap id="userOrderMap4" type="user">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="address" column="address"/>
        <collection property="orderses" ofType="orders">
            <id property="id" column="user_id"/>
            <result property="number" column="number"/>
            <result property="note" column="note"/>
            <collection property="orderdetails" ofType="com.puhui.vo.Orderdetail">
                <id property="id" column="orderdetail_id"/>
                <result property="itemsId" column="items_id"/>
                <result property="itemsNum" column="items_num"/>
            </collection>
        </collection>
    </resultMap>
    <sql id="query where condition">
        <where>
            <if test="array!=null">
                <foreach collection="array" index="index" item="item" open="and id in(" separator="," close=")">
                    #{item}
                </foreach>
            </if>
        </where>
    </sql>
    <!-- 根据id获取用户信息 -->
    <select id="findUserById" parameterType="int" resultType="com.puhui.vo.User">
        select * from user where id = #{id}
    </select>
    <!-- 自定义条件查询用户列表 -->
    <select id="findUserByUsername" parameterType="java.lang.String"
            resultType="com.puhui.vo.User">
        select * from user where username like '%${value}%'
    </select>
    <!-- 添加用户 -->
    <insert id="insertUser" parameterType="com.puhui.vo.User">
        <selectKey keyProperty="id" order="AFTER" resultType="java.lang.Integer">
            select LAST_INSERT_ID()
        </selectKey>
        insert into user(username,birthday,sex,address)
        values(#{user.username},#{user.birthday},#{user.sex},#{user.address})
    </insert>

    <select id="findUserByHashMap" parameterType="hashmap" resultType="user">
        SELECT * FROM user
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="username != null">
                AND username like '%${username}%'
            </if>
        </where>
    </select>
    <select id="findUserByQueryVo" parameterType="QueryVo" resultType="com.puhui.vo.User">
        SELECT * FROM user
        <where>
            <if test="user.username != null">
                AND username =#{user.username}
            </if>
            <if test="user.id != null">
                AND id = #{user.id}
            </if>

        </where>
    </select>
    <select id="getAllUser" resultType="java.lang.Integer">
        SELECT COUNT(1) FROM user
    </select>
    <select id="queryUserByManyCondition" resultType="com.puhui.vo.User">
        SELECT * FROM user
        <where>
            <if test="id != null">
                AND id = #{id}
            </if>
            <if test="username != null">
                AND username = #{username}
            </if>
            <if test="address != null">
                AND address = #{address}
            </if>
        </where>
    </select>
    <select id="getMapByQueryAllUser" resultType="java.util.Map">
        SELECT * FROM user WHERE id = 1;
    </select>

    <select id="queryUserListByArray" parameterType="Object[]" resultType="User">
        SELECT * FROM user
        <where>
            <if test="array!= null">
                <foreach collection="array" index="index" item="item" open="and id in(" separator="," close=")">
                    #{item.id}
                </foreach>
            </if>
        </where>
    </select>

    <select id="queryUserListByStringArray" parameterType="Object[]" resultType="User">
        SELECT * FROM user
        <include refid="query where condition"/>
    </select>


    <!--一对一查询-，自定义 VO 类-->
    <select id="queryOrderList" resultType="com.puhui.vo.OrderCustom">
        SELECT orders.*,username,address
        FROM user,orders
        WHERE user.id = orders.user_id;
    </select>
    <!--一对一查询，使用 resultMap 进行查询-->
    <select id="queryOrderList2" resultMap="userOrderMap">
        SELECT orders.*,user.username,user.address
        FROM orders,user
        WHERE user.id = orders.user_id;
    </select>
    <!--一对多查询，使用 resultMap 进行查询-->
    <select id="queryOrderDetailList" resultMap="userOrderMap3">
        SELECT orders.*,user.username,user.address,orderdetail.id,orderdetail.orders_id,orderdetail.items_id,orderdetail.items_num
        FROM orderdetail,orders,user
        WHERE user.id = orders.user_id AND orderdetail.orders_id = orders.id;
    </select>

    <select id="queryOrderDetailList2" resultMap="userOrderMap4">
        SELECT user.username,user.address,orders.*,orderdetail.items_num,orderdetail.orders_id
        FROM orderdetail,orders,user
        WHERE user.id = orders.user_id AND orderdetail.orders_id = orders.id;
    </select>
</mapper>